##############################################################################
# dnsmasq Configuration for Raspberry Pi 5 Network Deployment System
# Deployment Server: cw-rpi-deployment01
# Created: 2025-10-23
# Phase: 3 - DHCP and TFTP Configuration
##############################################################################

##############################################################################
# NETWORK INTERFACE BINDING
# CRITICAL: Only serve DHCP/TFTP on the deployment network (eth1)
##############################################################################

# Listen ONLY on eth1 (192.168.151.1) - deployment network
interface=eth1

# Bind to specific interfaces only (security measure)
# This prevents dnsmasq from listening on all interfaces
bind-interfaces

# Explicitly exclude management network interface
# This ensures NO DHCP is served on eth0 (192.168.101.146)
except-interface=eth0

# Do not use /etc/resolv.conf for upstream DNS
# We provide explicit DNS servers to clients
no-resolv

# Do not poll /etc/resolv.conf for changes
no-poll

##############################################################################
# DHCP CONFIGURATION - Deployment Network Only
##############################################################################

# DHCP range for deployment network (150 addresses)
# Range: 192.168.151.100 - 192.168.151.250
# Lease time: 12 hours (sufficient for imaging process)
dhcp-range=192.168.151.100,192.168.151.250,12h

# Set as authoritative DHCP server on this network
# This allows dnsmasq to respond immediately without waiting
# Safe because this is an isolated deployment network
dhcp-authoritative

# Maximum number of DHCP leases
# 150 addresses available (100-250)
dhcp-lease-max=150

# DHCP lease file location (default is fine)
dhcp-leasefile=/var/lib/misc/dnsmasq.leases

##############################################################################
# DHCP OPTIONS - Network Configuration for Clients
##############################################################################

# DHCP Option 3: Router/Gateway
# COMMENTED OUT - No routing on isolated deployment network for security
# Raspberry Pis do not need internet access during imaging
#dhcp-option=3,192.168.151.1

# DHCP Option 6: DNS Servers
# Provide DNS servers for temporary use during imaging
# These are only used if the installer needs to resolve hostnames
dhcp-option=6,8.8.8.8,8.8.4.4

# DHCP Option 43: Vendor-Specific Information for Raspberry Pi
# CRITICAL for Raspberry Pi 5 network boot
# Pi bootloader checks for this exact string
dhcp-option=43,"Raspberry Pi Boot"

# DHCP Option 66: TFTP Server IP Address
# Tell clients where to find the TFTP server (this machine)
dhcp-option=66,192.168.151.1

# DHCP Option 1: Subnet Mask (automatically set by dhcp-range, but explicit for clarity)
# dhcp-option=1,255.255.255.0

##############################################################################
# PXE BOOT CONFIGURATION - Raspberry Pi 5 (UEFI ARM64)
##############################################################################

# Match different client architectures using DHCP option 93
# Reference: RFC 4578 - DHCP Client Architecture Type
#
# Common architecture codes:
#   0  = x86 BIOS (Legacy PC)
#   6  = x86_64 UEFI
#   7  = EFI x86-64 (64-bit EFI)
#   9  = EFI x86-64 HTTP
#   11 = ARM 64-bit UEFI (Raspberry Pi 5)

# Set tag for ARM 64-bit UEFI clients (Raspberry Pi 5)
dhcp-match=set:efi-arm64,option:client-arch,11

# Also match standard x86_64 UEFI (for testing/compatibility)
dhcp-match=set:efi-x86_64,option:client-arch,7
dhcp-match=set:efi-x86_64,option:client-arch,9

# Boot file for ARM64 UEFI clients (Raspberry Pi 5)
# Path is relative to tftp-root (/tftpboot)
dhcp-boot=tag:efi-arm64,config.txt

# Boot file for x86_64 UEFI clients (optional, for testing)
# dhcp-boot=tag:efi-x86_64,bootfiles/boot_x86.ipxe

##############################################################################
# BUILT-IN TFTP SERVER CONFIGURATION
##############################################################################

# Enable dnsmasq's built-in TFTP server
enable-tftp

# TFTP root directory (where boot files are stored)
tftp-root=/tftpboot

# Make TFTP more secure - only serve world-readable files
# This prevents accidental exposure of sensitive files
#tftp-secure

# Don't abort startup if tftp-root is temporarily unavailable
tftp-no-fail

# Disable TFTP blocksize negotiation for better Pi compatibility
# Some older Pi firmware has issues with non-standard block sizes
tftp-no-blocksize

# Maximum number of concurrent TFTP connections
# Default is 50, increase for mass deployments
# Adjust based on expected concurrent Pi boot count
#tftp-max=100

##############################################################################
# DNS CONFIGURATION
##############################################################################

# Disable DNS function entirely (we only need DHCP and TFTP)
# Setting port to 0 disables DNS, reducing attack surface
port=0

# If DNS is needed later, uncomment the following:
# port=53
# cache-size=150
# no-negcache

##############################################################################
# LOGGING CONFIGURATION
##############################################################################

# Enable DHCP transaction logging
log-dhcp

# Log DNS queries (if DNS is enabled)
#log-queries

# Log to specific file instead of syslog
log-facility=/var/log/dnsmasq.log

# Async logging for better performance under load
log-async=20

##############################################################################
# SECURITY AND FILTERING
##############################################################################

# Ignore WPAD DHCP name requests (security vulnerability)
# See CERT Vulnerability VU#598349
dhcp-name-match=set:wpad-ignore,wpad
dhcp-ignore-names=tag:wpad-ignore

# Filter useless Windows-originated DNS requests
# Note: Only relevant if DNS is enabled
#filterwin2k

# Never forward plain names (names without dots)
# Note: Only relevant if DNS is enabled
#domain-needed

# Never forward addresses in non-routed address spaces
# Note: Only relevant if DNS is enabled
#bogus-priv

##############################################################################
# PERFORMANCE TUNING
##############################################################################

# Disable reading /etc/hosts (not needed for this use case)
no-hosts

# Disable DNS lookups for DHCP hostnames
#no-resolv

# Increase DHCP packet queue size for high concurrency
# Useful when imaging multiple Pis simultaneously
#dhcp-sequential-ip

##############################################################################
# DEBUG AND TROUBLESHOOTING
##############################################################################

# Uncomment for verbose debugging (generates lots of logs)
#log-queries
#log-dhcp

# Uncomment to test configuration syntax
#test

##############################################################################
# ADDITIONAL CONFIGURATION FILES
##############################################################################

# Include additional configuration from /etc/dnsmasq.d/
# Allows modular configuration without editing main file
conf-dir=/etc/dnsmasq.d/,*.conf

##############################################################################
# END OF CONFIGURATION
##############################################################################
